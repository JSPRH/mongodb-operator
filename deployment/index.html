
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../argocd/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.3">
    
    
      
        <title>Deployment - MongoDB Operator</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.c4a75a56.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#deployment-of-the-mongodb-operator" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="MongoDB Operator" class="md-header__button md-logo" aria-label="MongoDB Operator" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MongoDB Operator
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Deployment
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
      </form>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="MongoDB Operator" class="md-nav__button md-logo" aria-label="MongoDB Operator" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    MongoDB Operator
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        MongoDB Operator
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Deployment
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Deployment
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mongodb-operator-requirements" class="md-nav__link">
    MongoDB Operator Requirements
  </a>
  
    <nav class="md-nav" aria-label="MongoDB Operator Requirements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kubernetes" class="md-nav__link">
    Kubernetes
  </a>
  
    <nav class="md-nav" aria-label="Kubernetes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service-account" class="md-nav__link">
    Service Account
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-resource-definition" class="md-nav__link">
    Custom Resource Definition
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database" class="md-nav__link">
    Database
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mongodb-operator-image" class="md-nav__link">
    MongoDB Operator Image
  </a>
  
    <nav class="md-nav" aria-label="MongoDB Operator Image">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#base-image" class="md-nav__link">
    Base Image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#environment-variables" class="md-nav__link">
    Environment Variables
  </a>
  
    <nav class="md-nav" aria-label="Environment Variables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#java" class="md-nav__link">
    Java
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb" class="md-nav__link">
    MongoDB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    Logging
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#endpoints" class="md-nav__link">
    Endpoints
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../argocd/" class="md-nav__link">
        ArgoCD
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        Usage
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../process/" class="md-nav__link">
        How the MongoDB Operator works
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mongodb-operator-requirements" class="md-nav__link">
    MongoDB Operator Requirements
  </a>
  
    <nav class="md-nav" aria-label="MongoDB Operator Requirements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kubernetes" class="md-nav__link">
    Kubernetes
  </a>
  
    <nav class="md-nav" aria-label="Kubernetes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service-account" class="md-nav__link">
    Service Account
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-resource-definition" class="md-nav__link">
    Custom Resource Definition
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#database" class="md-nav__link">
    Database
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mongodb-operator-image" class="md-nav__link">
    MongoDB Operator Image
  </a>
  
    <nav class="md-nav" aria-label="MongoDB Operator Image">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#base-image" class="md-nav__link">
    Base Image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#environment-variables" class="md-nav__link">
    Environment Variables
  </a>
  
    <nav class="md-nav" aria-label="Environment Variables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#java" class="md-nav__link">
    Java
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb" class="md-nav__link">
    MongoDB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    Logging
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#endpoints" class="md-nav__link">
    Endpoints
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="deployment-of-the-mongodb-operator">Deployment of the MongoDB Operator<a class="headerlink" href="#deployment-of-the-mongodb-operator" title="Permanent link">&para;</a></h1>
<h2 id="mongodb-operator-requirements">MongoDB Operator Requirements<a class="headerlink" href="#mongodb-operator-requirements" title="Permanent link">&para;</a></h2>
<p>To function properly, some requirements in the Kubernetes deployment must be met, and a MongoDB
database instance dedicated to the Kubernetes cluster must be set up.</p>
<p>The MongoDB Operator expects a strict 1 to 1 relation of Kubernetes Cluster and MongoDB database
instance.
Exactly one MongoDB Operator replica must be deployed in one Kubernetes Cluster watching all
namespaces.
This MongoDB Operator is the only one managing users of the MongoDB database instance dedicated to
the Kubernetes cluster.
Database names and usernames are created based on namespace name and MongoDB resource name to avoid
naming conflicts.
A database instance managed by multiple MongoDB Operators for multiple clusters would cause name
conflicts and access to the same database from multiple clusters.</p>
<h3 id="kubernetes">Kubernetes<a class="headerlink" href="#kubernetes" title="Permanent link">&para;</a></h3>
<p>An <a href="https://github.com/SDA-SE/mongodb-operator/tree/master/kustomize/bases/operator">example deployment of the MongoDB Operator</a>
that covers the following requirements is available in the GitHub Repository of the MongoDB
Operator.</p>
<h4 id="service-account">Service Account<a class="headerlink" href="#service-account" title="Permanent link">&para;</a></h4>
<p>The MongoDB Operator requires a <code>ServiceAccount</code> with some privileges for the Kubernetes API from a
<code>ClusterRole</code>:</p>
<ul>
<li>For the resource <code>mongodbs</code> the following verbs are required:<ul>
<li><code>watch</code></li>
<li><code>list</code></li>
<li><code>get</code></li>
<li><code>update</code></li>
</ul>
</li>
<li>For the resource <code>mongodbs/status</code> the following verbs are required:<ul>
<li><code>watch</code></li>
<li><code>list</code></li>
<li><code>get</code></li>
<li><code>update</code></li>
</ul>
</li>
<li>For the resource <code>secrets</code> the following verbs are required:<ul>
<li><code>create</code></li>
<li><code>update</code></li>
</ul>
</li>
<li>For the resource <code>customresourcedefinitions</code> with the resource name
  <code>mongodbs.persistence.sda-se.com</code> the following verbs are required:<ul>
<li><code>get</code></li>
</ul>
</li>
</ul>
<h4 id="custom-resource-definition">Custom Resource Definition<a class="headerlink" href="#custom-resource-definition" title="Permanent link">&para;</a></h4>
<p>The <a href="https://github.com/SDA-SE/mongodb-operator/tree/master/kustomize/bases/operator/mongodbs-crd.yaml">CRD <code>mongodbs</code></a>
must be applied.</p>
<h3 id="database">Database<a class="headerlink" href="#database" title="Permanent link">&para;</a></h3>
<p>A MongoDB database instance or an AWS DocumentDB cluster must be set up separately from the
deployment of the MongoDB Operator.</p>
<p>A user for MongoDB Operator must be created.</p>
<p>The user of the MongoDB Operator must be granted
<a href="https://docs.mongodb.com/v4.4/reference/built-in-roles/#mongodb-authrole-userAdminAnyDatabase"><code>userAdminAnyDatabase</code></a>
to function properly.</p>
<p><a href="https://docs.mongodb.com/v4.4/reference/built-in-roles/#mongodb-authrole-dbAdminAnyDatabase"><code>dbAdminAnyDatabase</code></a>
is needed to support <code>spec.database.pruneAfterDelete: true</code> of the MongoDB custom resource.
<code>pruneAfterDelete</code> is suggested for develop and test environments only where pull request or
temporary test deployments could create a big amount of temporary used databases.</p>
<h2 id="mongodb-operator-image">MongoDB Operator Image<a class="headerlink" href="#mongodb-operator-image" title="Permanent link">&para;</a></h2>
<p>The image is hosted at <a href="https://quay.io/repository/sdase/mongodb-operator">quay.io/sdase/mongodb-operator</a>.</p>
<h3 id="base-image">Base Image<a class="headerlink" href="#base-image" title="Permanent link">&para;</a></h3>
<p>This container is based on the distroless <a href="https://quay.io/repository/sdase/openjdk-runtime">SDA OpenJDK base image</a>.
The base image provides both manual and automatic ways to configure memory limits of the JVM.</p>
<h3 id="environment-variables">Environment Variables<a class="headerlink" href="#environment-variables" title="Permanent link">&para;</a></h3>
<p>The following environment variables can be used to configure the Docker container:</p>
<h4 id="java">Java<a class="headerlink" href="#java" title="Permanent link">&para;</a></h4>
<ul>
<li><code>JAVA_TOOL_OPTIONS</code> <em>string</em><ul>
<li>Set options for the JVM.
  If Java options are set, you will find <em>Picked up JAVA_TOOL_OPTIONS: "-Xmx340m"</em> or similar in
  the log.</li>
<li>Example: <code>-Xmx340m</code> to set the max heap size</li>
</ul>
</li>
</ul>
<h4 id="mongodb">MongoDB<a class="headerlink" href="#mongodb" title="Permanent link">&para;</a></h4>
<p>When connecting to the MongoDB, the configured hosts are checked.
If any ends with <code>.docdb.amazonaws.com</code>, a connection to AWS DocumentDB is assumed, and the behavior
slightly changes.
While users for requested databases are created in the database when using MongoDB, all users will
be created in the <code>admin</code> database when AWS DocumentDB is used.</p>
<ul>
<li><code>MONGODB_CONNECTION_STRING</code> <em>string</em><ul>
<li>The connection String that covers all configuration to access the MongoDB database.</li>
<li>Example: <code>mongodb://username:password@mongodb.mongodb:27017</code></li>
</ul>
</li>
<li><code>TRUSTED_CERTIFICATES_DIR</code><ul>
<li>Directory in the container where CA certificates or certificate bundles in PEM format can be
  mounted. These certificates are used to verify SSL connections to the database.
  The configuration is ignored if no files are mounted.
  Startup will fail if the directory is not readable.</li>
<li>Default: <code>/var/trust/certificates</code></li>
</ul>
</li>
</ul>
<h4 id="logging">Logging<a class="headerlink" href="#logging" title="Permanent link">&para;</a></h4>
<ul>
<li><code>ENABLE_JSON_LOGGING</code> <em>boolean</em><ul>
<li>Enables logging as Json if <code>true</code> (case-insensitive).
  Configuration errors are never logged as Json.
  Each log will be one line of Json, containing the keys:<ul>
<li><code>level</code>: <code>"INFO"</code>, <code>"WARN"</code> or <code>"ERROR"</code>.</li>
<li><code>message</code>: The log message.</li>
<li><code>exception</code>: The exception, if any.</li>
<li><code>mdc</code>: Object with additional key-value information, if any.</li>
</ul>
</li>
<li>Default: <em>none</em>, effectively <code>false</code> </li>
</ul>
</li>
</ul>
<h3 id="endpoints">Endpoints<a class="headerlink" href="#endpoints" title="Permanent link">&para;</a></h3>
<p>The image exposes port <code>8081</code> for monitoring purposes.</p>
<p>It provides the following endpoints:</p>
<ul>
<li>Readiness: <code>http://{serviceUrl}:8081/health/readiness</code></li>
<li>Liveness: <code>http://{serviceUrl}:8081/health/liveness</code></li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href=".." class="md-footer__link md-footer__link--prev" aria-label="Previous: MongoDB Operator" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                MongoDB Operator
              </div>
            </div>
          </a>
        
        
          
          <a href="../argocd/" class="md-footer__link md-footer__link--next" aria-label="Next: ArgoCD" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                ArgoCD
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.footer", "content.action.edit"], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.efa0ade1.min.js"></script>
      
        <script src="../search/main.js"></script>
      
    
  </body>
</html>