
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.3.9">
    
    
      
        <title>Usage - MongoDB Operator Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#usage-of-the-mongodb-resource" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="MongoDB Operator Documentation" class="md-header__button md-logo" aria-label="MongoDB Operator Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MongoDB Operator Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Usage
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="MongoDB Operator Documentation" class="md-nav__button md-logo" aria-label="MongoDB Operator Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    MongoDB Operator Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        MongoDB Operator
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../deployment/" class="md-nav__link">
        Deployment
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Usage
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Usage
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#caveats" class="md-nav__link">
    Caveats
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kustomize" class="md-nav__link">
    Kustomize
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#caveats" class="md-nav__link">
    Caveats
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kustomize" class="md-nav__link">
    Kustomize
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="usage-of-the-mongodb-resource">Usage of the MongoDB resource</h1>
<p>When a MongoDB Operator is installed in a Kubernetes cluster, it watches <code>MongoDB</code> custom resources.
Creating a <code>MongoDB</code> resource in a namespace triggers that a database user for resource is created.</p>
<p>To request a MongoDB database with associated user in a cluster with the MongoDB Operator, a
resource like the following must be applied:</p>
<pre><code class="language-yaml">apiVersion: persistence.sda-se.com/v1beta1
kind: MongoDb
metadata:
  name: my-db
  namespace: test-namespace
spec:
  database:
    pruneAfterDelete: true # optional, default false
    connectionStringOptions: &quot;&quot; # optional, defaults to the ones used by MongoDB operator
  secret:
    databaseKey: d # optional, default 'database'
    usernameKey: u # optional, default 'username'
    passwordKey: p # optional, default 'password'
    connectionStringKey: c  # optional, default 'connectionString'
</code></pre>
<p>This will create a database named <code>test-namespace_my-db</code> and the user <code>test-namespace_my-db</code> with
read-write access to that database and a secret named <code>my-db</code> in <code>test-namespace</code>.
The secret will provide the data <code>d: test-namespace_my-db</code>, <code>u: test-namespace_my-db</code> and
<code>p: &lt;random-password&gt;</code> (with base64 encoded values).</p>
<p>When the MongoDB resource is deleted, the database user and the secret are deleted as well.
If <code>spec.database.pruneAfterDelete</code> is true, the whole database with all content will be deleted.</p>
<p>With an appropriate Kustomize configuration (similar to the configuration required for Sealed
Secrets), databases created this way can be used in PR deployments with name suffix.</p>
<p>The <code>connectionStringOptions</code> will overwrite the defaults which are used by the MongoDB operator itself
to connect to the MongoDB. </p>
<h2 id="caveats">Caveats</h2>
<ul>
<li><code>spec.database.pruneAfterDelete: true</code> is only supported if the user of the MongoDB Operator is
  allowed to drop databases.</li>
<li>Other settings than available in the secret for the database instance are not covered by the
  MongoDB Operator yet.
  <code>host</code>, <code>options</code>, etc. must be configured separately for each Kubernetes cluster unless the
  workload is configured with the <code>connectionString</code>.</li>
<li>The <code>authSource</code> is the allowed database itself for MongoDB instances and the admin database for
  DocumentDB instances.
  As DocumentDB uses the admin database for all users, there is no need to configure <code>authSource</code>.</li>
<li>There is a hard limit of 64 characters for the database name.
  The database name is built from <code>&lt;metadata.namespace&gt;_&lt;metadata.name&gt;</code>.
  The namespace is used to avoid collisions and therefore data security issues.
  Be aware that the length of <code>metadata.namespace</code> plus the length of <code>metadata.name</code> does not
  exceed 63 characters.
  This error can be recognized in the log of the Operator and by the fact that no Secret is created
  for the MongoDb resource.</li>
<li>In some rare cases the created secret does not match the created MongoDB user due to concurrency
  issues.
  We are still investigating on this bug.
  In such cases, the MongoDB resource can be deleted and created again to trigger a new setup of the
  user.
  This workaround <strong>will delete the database and all collections</strong> if
  <code>spec.database.pruneAfterDelete: true</code> is set and the MongoDB Operator has the
  <a href="../deployment/#database">required privileges</a>.
  It is important to disable <code>spec.database.pruneAfterDelete</code> and do not grant more than
  <code>userAdminAnyDatabase</code> to the MongoDB Operator user in production environments.</li>
</ul>
<h2 id="kustomize">Kustomize</h2>
<p>When using <a href="https://kustomize.io/">Kustomize</a> with <code>namePrefix</code> or <code>nameSuffix</code>, the MongoDb
resource must be treated the same way as a Secret, because a Secret with the same name will be
created by the MongoDB Operator.</p>
<p>The following configuration needs to be added to the <code>kustomization.yaml</code>.
It is derived from the built in <code>Secret</code> configuration. </p>
<pre><code class="language-yaml">apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

configurations:
  - mongodb-configuration.yaml
</code></pre>
<pre><code class="language-yaml"># mongodb-configuration.yaml
nameReference:

  # MongoDbs must be treated like Secrets when used in conjunction with name suffix or prefix
  - group: persistence.sda-se.com
    version: v1beta1
    kind: MongoDb
    fieldSpecs:
      # taken from the specs of v1/Secret
      # https://github.com/kubernetes-sigs/kustomize/blob/master/api/konfig/builtinpluginconsts/namereference.go#L120
      - path: spec/volumes/secret/secretName
        version: v1
        kind: Pod
      - path: spec/containers/env/valueFrom/secretKeyRef/name
        version: v1
        kind: Pod
      - path: spec/initContainers/env/valueFrom/secretKeyRef/name
        version: v1
        kind: Pod
      - path: spec/containers/envFrom/secretRef/name
        version: v1
        kind: Pod
      - path: spec/initContainers/envFrom/secretRef/name
        version: v1
        kind: Pod
      - path: spec/imagePullSecrets/name
        version: v1
        kind: Pod
      - path: spec/volumes/projected/sources/secret/name
        version: v1
        kind: Pod
      - path: spec/template/spec/volumes/secret/secretName
        kind: Deployment
      - path: spec/template/spec/containers/env/valueFrom/secretKeyRef/name
        kind: Deployment
      - path: spec/template/spec/initContainers/env/valueFrom/secretKeyRef/name
        kind: Deployment
      - path: spec/template/spec/containers/envFrom/secretRef/name
        kind: Deployment
      - path: spec/template/spec/initContainers/envFrom/secretRef/name
        kind: Deployment
      - path: spec/template/spec/imagePullSecrets/name
        kind: Deployment
      - path: spec/template/spec/volumes/projected/sources/secret/name
        kind: Deployment
      - path: spec/template/spec/volumes/secret/secretName
        kind: ReplicaSet
      - path: spec/template/spec/containers/env/valueFrom/secretKeyRef/name
        kind: ReplicaSet
      - path: spec/template/spec/initContainers/env/valueFrom/secretKeyRef/name
        kind: ReplicaSet
      - path: spec/template/spec/containers/envFrom/secretRef/name
        kind: ReplicaSet
      - path: spec/template/spec/initContainers/envFrom/secretRef/name
        kind: ReplicaSet
      - path: spec/template/spec/imagePullSecrets/name
        kind: ReplicaSet
      - path: spec/template/spec/volumes/projected/sources/secret/name
        kind: ReplicaSet
      - path: spec/template/spec/volumes/secret/secretName
        kind: DaemonSet
      - path: spec/template/spec/containers/env/valueFrom/secretKeyRef/name
        kind: DaemonSet
      - path: spec/template/spec/initContainers/env/valueFrom/secretKeyRef/name
        kind: DaemonSet
      - path: spec/template/spec/containers/envFrom/secretRef/name
        kind: DaemonSet
      - path: spec/template/spec/initContainers/envFrom/secretRef/name
        kind: DaemonSet
      - path: spec/template/spec/imagePullSecrets/name
        kind: DaemonSet
      - path: spec/template/spec/volumes/projected/sources/secret/name
        kind: DaemonSet
      - path: spec/template/spec/volumes/secret/secretName
        kind: StatefulSet
      - path: spec/template/spec/containers/env/valueFrom/secretKeyRef/name
        kind: StatefulSet
      - path: spec/template/spec/initContainers/env/valueFrom/secretKeyRef/name
        kind: StatefulSet
      - path: spec/template/spec/containers/envFrom/secretRef/name
        kind: StatefulSet
      - path: spec/template/spec/initContainers/envFrom/secretRef/name
        kind: StatefulSet
      - path: spec/template/spec/imagePullSecrets/name
        kind: StatefulSet
      - path: spec/template/spec/volumes/projected/sources/secret/name
        kind: StatefulSet
      - path: spec/template/spec/volumes/secret/secretName
        kind: Job
      - path: spec/template/spec/containers/env/valueFrom/secretKeyRef/name
        kind: Job
      - path: spec/template/spec/initContainers/env/valueFrom/secretKeyRef/name
        kind: Job
      - path: spec/template/spec/containers/envFrom/secretRef/name
        kind: Job
      - path: spec/template/spec/initContainers/envFrom/secretRef/name
        kind: Job
      - path: spec/template/spec/imagePullSecrets/name
        kind: Job
      - path: spec/template/spec/volumes/projected/sources/secret/name
        kind: Job
      - path: spec/jobTemplate/spec/template/spec/volumes/secret/secretName
        kind: CronJob
      - path: spec/jobTemplate/spec/template/spec/volumes/projected/sources/secret/name
        kind: CronJob
      - path: spec/jobTemplate/spec/template/spec/containers/env/valueFrom/secretKeyRef/name
        kind: CronJob
      - path: spec/jobTemplate/spec/template/spec/initContainers/env/valueFrom/secretKeyRef/name
        kind: CronJob
      - path: spec/jobTemplate/spec/template/spec/containers/envFrom/secretRef/name
        kind: CronJob
      - path: spec/jobTemplate/spec/template/spec/initContainers/envFrom/secretRef/name
        kind: CronJob
      - path: spec/jobTemplate/spec/template/spec/imagePullSecrets/name
        kind: CronJob
      - path: spec/tls/secretName
        kind: Ingress
      - path: metadata/annotations/ingress.kubernetes.io\/auth-secret
        kind: Ingress
      - path: metadata/annotations/nginx.ingress.kubernetes.io\/auth-secret
        kind: Ingress
      - path: metadata/annotations/nginx.ingress.kubernetes.io\/auth-tls-secret
        kind: Ingress
      - path: spec/tls/secretName
        kind: Ingress
      - path: imagePullSecrets/name
        kind: ServiceAccount
      - path: parameters/secretName
        kind: StorageClass
      - path: parameters/adminSecretName
        kind: StorageClass
      - path: parameters/userSecretName
        kind: StorageClass
      - path: parameters/secretRef
        kind: StorageClass
      - path: rules/resourceNames
        kind: Role
      - path: rules/resourceNames
        kind: ClusterRole
      - path: spec/template/spec/containers/env/valueFrom/secretKeyRef/name
        kind: Service
        group: serving.knative.dev
        version: v1
      - path: spec/azureFile/secretName
        kind: PersistentVolume

</code></pre>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../deployment/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Deployment" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Deployment
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
    
  </body>
</html>